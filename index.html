<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Data Analyst</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        :root {
            --background: #f7f8fc; --surface: #ffffff; --primary: #4f46e5; --primary-hover: #4338ca;
            --text-primary: #1f2937; --text-secondary: #6b7280; --user-bubble: var(--primary);
            --bot-bubble: #eef2ff; --border-color: #e5e7eb;
            --glass-bg: rgba(255, 255, 255, 0.7); --glass-border: rgba(255, 255, 255, 0.3);
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; width: 100%; margin: 0; overflow: hidden; }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--background); display: flex;
            justify-content: center; align-items: center; color: var(--text-primary);
        }
        .chat-container {
            width: 100%; height: 100%; background-color: var(--surface);
            display: flex; flex-direction: column; overflow: hidden;
            position: relative;
        }
        
        /* --- FITUR BARU: DYNAMIC ISLAND DENGAN EFEK --- */
        .dynamic-island {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            padding: 10px 20px;
            font-weight: 500;
            font-size: 16px;
            color: var(--text-primary);
            transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            
            /* Efek Liquid Glass */
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);

            /* Efek Tambahan */
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .dynamic-island.processing {
            padding-left: 12px;
            padding-right: 16px;
        }
        .processing-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--primary);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none; /* Sembunyi secara default */
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .chat-box {
            flex-grow: 1;
            padding: 24px;
            padding-top: 80px; /* Memberi ruang untuk Dynamic Island */
            overflow-y: auto;
        }
        /* ... (CSS lain dari versi sebelumnya) ... */
    </style>
</head>
<body>

<div class="chat-container">
    <div class="dynamic-island" id="dynamicIsland">
        <div class="processing-spinner" id="processingSpinner"></div>
        <span id="headerText">AI Data Analyst</span>
    </div>
    
    <div class="chat-box" id="chatBox">
        <div class="message bot-message">
            <span class="text"><p>Halo! Silakan ajukan pertanyaan atau lampirkan file data untuk dianalisis.</p></span>
        </div>
    </div>
    <div class="input-area">
        </div>
</div>

<script>
    // --- KONFIGURASI WAJIB ---
    const N8N_WEBHOOK_URL = 'https://devDaffas-n8nautov2.hf.space/webhook-test/azuredata';
    const API_KEY = '';
    // -------------------------

    const dynamicIsland = document.getElementById('dynamicIsland');
    const headerText = document.getElementById('headerText');
    const processingSpinner = document.getElementById('processingSpinner');
    // ... (variabel lain dari versi sebelumnya)

    const converter = new showdown.Converter({ tables: true });
    const sessionId = `session-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
    
    // --- FUNGSI-FUNGSI YANG DIPERBAIKI TOTAL ---
    const showLoadingIndicator = () => {
        dynamicIsland.classList.add('processing');
        processingSpinner.style.display = 'block';
        headerText.textContent = 'Menganalisis...';
    };

    const hideLoadingIndicator = () => {
        dynamicIsland.classList.remove('processing');
        processingSpinner.style.display = 'none';
        headerText.textContent = 'AI Data Analyst';
    };

    const addMessage = (content, sender) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;
        const textSpan = document.createElement('span');
        textSpan.className = 'text';
        textSpan.innerHTML = content;
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    };

    const sendMessage = async () => {
        const userMessage = userInput.value.trim();
        const userFile = fileInput.files[0];
        if (!userMessage && !userFile) return;

        if (userMessage) {
            addMessage(userMessage.replace(/</g, "&lt;").replace(/>/g, "&gt;"), 'user');
        }
        
        userInput.value = '';
        showLoadingIndicator();

        const formData = new FormData();
        formData.append('message', userMessage);
        formData.append('sessionId', sessionId);
        if (userFile) formData.append('file', userFile);

        try {
            const fetchOptions = { method: 'POST', body: formData, headers: {}, };
            if (API_KEY) { fetchOptions.headers['X-API-KEY'] = API_KEY; }

            const response = await fetch(N8N_WEBHOOK_URL, fetchOptions);
            hideLoadingIndicator();
            
            if (!response.ok) { throw new Error(`HTTP error! Status: ${response.status}`); }

            const data = await response.json();
            const botReplyMarkdown = data.reply || 'Maaf, saya tidak menerima balasan yang valid.';
            const botReplyHtml = converter.makeHtml(botReplyMarkdown);
            addMessage(botReplyHtml, 'bot');
        } catch (error) {
            console.error('Error:', error);
            hideLoadingIndicator();
            addMessage(`Terjadi kesalahan: ${error.message}`, 'bot');
        } finally {
            fileInput.value = '';
            // Reset indikator file jika ada (jika Anda ingin menambahkannya kembali)
        }
    };

    // Tambahkan event listener di sini, setelah semua fungsi didefinisikan
    const sendButton = document.getElementById('sendButton');
    const userInput = document.getElementById('userInput');
    const fileInput = document.getElementById('fileInput');

    sendButton.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') sendMessage(); });
    
</script>

</body>
</html>
